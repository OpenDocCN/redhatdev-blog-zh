# 监控 RHGS

> 原文:[https://developers . red hat . com/blog/2017/11/20/monitoring-rhgs](https://developers.redhat.com/blog/2017/11/20/monitoring-rhgs)

好了，你看了:

[https://www . red hat . com/en/about/videos/architecting-and-performance-tuning-efficient-g luster-storage-pools](https://www.redhat.com/en/about/videos/architecting-and-performance-tuning-efficient-gluster-storage-pools)

您投入了时间，构建了一个高效且高性能的 GlusterFS 部署。您的用户在读写，应用程序在运行，Gluster 在保护您的数据安全。

现在怎么办？

恭喜你刚刚完成了冲刺！现在是马拉松时间了。

性能调优中经常被遗忘的部分是监控，您预先投入了所有工作来让您的集群运行并让您的用户满意，现在您如何确保这种情况持续下去并有可能改善呢？这一切都是通过持续监控和分析您的存储集群、客户端以及更深入地了解您的工作负载来实现的。在这篇博客中，我们将探讨您可以在存储集群中监控的不同指标，确定哪些指标需要监控、监控频率以及实现监控的不同方式。

我将把我们要看的指标分成几个不同的类别:

1.  系统资源
2.  集群资源
3.  客户端资源

系统资源是您将在任何 Linux 系统上监视的典型事物，包括:

*   中央处理器
*   随机存取存储
*   网络
*   唱片
*   处理

应该在集群中的所有节点上监视系统资源，并且应该逐个查看。

接下来，我们有集群资源。群集资源包括:

*   傲慢的同龄人
*   Gluster 卷
*   地理复制

应该只从一个节点监控集群资源，当前的 GlusterD 实现对同时从多个节点运行命令有一些限制，同时从多个节点监控集群范围内的事情是多余的。从多个节点同时运行一个命令可能会导致一些附带的事情，例如临时警告另一个节点有锁，并且命令无法完成，导致更严重的锁丢失，其中所有 Gluster 都被阻塞，直到持有锁的节点上的 GlusterD 服务被重新启动。我想重申，gluster volume/etc 命令必须只能从一个节点上运行。

最后一点是留意你的客户。这可能是您希望与存储集群一起监控的内容，也可能不是，这样做有利也有弊。由于 Gluster 会消耗 CPU、内存和网络，因此查看 gluster 进程在客户端执行的操作会很有用。对于我关注的客户:

*   中央处理器
*   随机存取存储
*   网络
*   格鲁斯特过程
*   可用空间
*   Gluster 装载上的 IOPs /吞吐量
*   正在使用的客户端数量

在这篇博客中，我将给出一些建议，关于运行什么命令来查看资源使用情况，多长时间运行一次这些命令，以及它们应该在什么系统上运行。我将尝试给出几个例子来说明如何实现这一点，但是由于每个人的环境都是不同的，并且可以使用各种工具，所以我将尽量不针对特定的工具。

既然我们已经完成了概述，让我们进入杂草一点。让我们从监控 Gluster 存储集群节点的资源开始。为了进一步扩展我在上面列出的服务器资源，我想深入了解我们将为每个资源组查看的数据点，以及检查该资源使用情况的可能方法:

*   中央处理器
    *   CPU 使用率(每个 CPU 的利用率百分比)
        *   顶部-> 1
    *   上下文切换
        *   sar -w
    *   系统负载
        *   sar -q
    *   正在使用 CPU 资源的位置(系统/用户/等待/窃取)
        *   合成孔径雷达 C
*   随机存取存储
    *   RAM 使用
        *   free -m -> available 列，请确保考虑到可用内存
    *   交换用法
        *   自由-m
    *   集群进程使用的 ram
        *   PS aux | grep g luster-->一定要看 RSS(常驻/实际使用量)而不是 VSZ(虚拟/共享内存使用量)
*   网络
    *   发送统计数据
        *   ifstat
    *   接收统计数据
        *   ifstat
    *   丢弃的数据包
        *   ifconfig
    *   重新传输
        *   ifconfig
*   唱片
    *   LVM 精简池使用情况
        *   lvdisplay ->分配的池数据
    *   LVM 元数据使用
        *   lvdisplay ->分配的元数据
    *   等待
        *   iostat -c -m -x
    *   利用率百分比(IOPs)
        *   iostat -c -m -x
    *   砖的使用空间
        *   东风-h
*   处理
    *   寻找热线程
        *   top-H-->查找长时间(秒)100%占用 CPU 的线程。)

我作为例子使用的系统级命令只是大多数管理员应该知道的日常 Linux 命令。这取决于你想多长时间监控一次这些数据点，如果这是你需要密切关注的事情，我会在几分钟内查看它们。如果你没有资源限制，我会把时间延长到 10 分钟甚至更长。尽管这些命令是轻量级的，并且经过了良好的测试/使用，但是它们仍然会占用一些系统资源，成功监控的关键之一是确保您的监控不会影响集群的性能。

接下来，我们将了解集群级命令，这些命令大多是 gluster 命令，我想再次重申，它们应该只在一个节点上执行！集群范围的命令往往对系统更具入侵性，所以我们应该保持这些命令的运行频率大大低于系统级命令。我喜欢关注的集群级命令有:

*   傲慢的同龄人
    *   gluster 同级状态
*   Gluster 卷
    *   gluster 音量状态
    *   gluster 卷重新平衡<volname>状态</volname>
*   地理复制
    *   gluster 卷地理复制状态->详细信息添加一些有用的信息
*   小酒馆
    *   gluster 卷位旋转<volname>擦除状态</volname>
*   快照
    *   gluster 快照状态
*   夏枯草
    *   gluster 卷修复<volname>信息</volname>
    *   gluster volume heal <volname>信息裂脑</volname>
*   配额
    *   gluster 卷配额<volname>列表</volname>

同样，应该减少这些命令的运行频率，并且一次只能从一个节点运行。侵入性较小的命令(包括对等状态、卷状态和配额列表)可以更频繁地运行，可能每 30-120 分钟运行一次。侵入性越强的命令，我运行的次数就越少，可能每天 4-6 次。您可以选择更频繁地运行这些命令，但要记住，您不希望您的监视命令给集群增加额外的负载。

最后一组是客户端命令。如果您使用 Gluster 作为应用程序的后备存储，这可能是一个灰色区域，您可能希望单独监控您的应用程序和存储集群。我只是列出了我会看的东西，你可以实现这些你选择的方式。客户端命令有点像集群和系统级别的混合，应该根据它们所属的组来考虑它们的运行频率:

*   中央处理器
    *   CPU 使用率(每个 CPU 的利用率百分比)
        *   顶部-> 1
    *   上下文切换
        *   sar -w
    *   系统负载
        *   sar -q
    *   正在使用 CPU 资源的位置(系统/用户/等待/窃取)
        *   合成孔径雷达 C
*   随机存取存储
    *   RAM 使用
        *   free -m -> available 列，请确保考虑到可用内存
    *   交换用法
        *   自由-m
    *   集群进程使用的 ram
        *   PS aux | grep g luster-->一定要看 RSS(常驻/实际使用量)而不是 VSZ(虚拟/共享内存使用量)
*   网络
    *   发送统计数据
        *   ifstat
    *   接收统计数据
        *   ifstat
    *   丢弃的数据包
        *   ifconfig
    *   重新传输
        *   ifconfig
*   格鲁斯特过程
    *   ps aux ->查看 RSS /内存使用情况
    *   top -H ->再次查找热线程
*   可用空间
    *   东风-h
*   Gluster 装载上的 IOPs /吞吐量
    *   这可能是一个棘手的问题，您可以设置一个脚本来运行一个小的读/写测试，以测量您在卷上获得的吞吐量
*   正在使用的客户端数量
    *   gluster v 状态<volname>客户端</volname>

在一般的 NAS 使用案例中，监控客户端不太重要，但是如果您是超级聚合和/或使用 Gluster 来支持任务关键型应用程序，那么客户端监控就变得更加重要。对于系统级别的资源，我将遵循与上面详述的相同的准则。对于集群级命令，我会一天查看几次，如果您想运行实际的读/写测试，我认为一天一次就足够了。

我希望这篇博客能提供足够多的细节来说明监控集群/系统/客户机资源的内容和频率。我将留给您一些我在监控我的集群时试图坚持的关键想法:

1.  不要让您的监控以任何方式干扰集群的性能。
2.  运行群集范围的监视命令的频率比运行系统命令的频率低，因为它们的开销要大得多。
3.  尽可能少地运行监视命令，同时仍然有效地监视资源。
4.  一次只从一个节点运行集群(gluster 命令)!

感谢阅读！

-乙

* * *

**无论你是容器新手还是有经验的人，下载这个** [**备忘单**](https://developers.redhat.com/promotions/docker-cheatsheet/) **可以在遇到你最近没有完成的任务时帮助你。**

*Last updated: November 15, 2017*