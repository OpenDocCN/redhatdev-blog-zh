# 使用 Debezium 在 Apache Kafka 中捕获 Oracle 数据库事件

> 原文：<https://developers.redhat.com/blog/2021/04/19/capture-oracle-database-events-in-apache-kafka-with-debezium>

最受欢迎的连接器插件之一即将进入 [Red Hat Integration。](/integration)现在，您可以在开发人员预览版中使用 Debezium connector for Oracle 从 Oracle 数据库中传输数据。

有了这个新的连接器，开发人员可以利用 100%开源的 Debezium 项目的力量将他们的 Oracle 数据传输到与 Red Hat 集成的 T2 红帽 AMQ 流和 T4 Apache Kafka 集群。

本文概述了用于 Oracle 的 Debezium 连接器。它将带您完成开始对 Oracle 数据库进行流式处理的步骤，以便您可以为您的数据实现[解放](https://twitter.com/gunnarmorling/status/1123191912800845825)

**注意:** Red Hat 鼓励您使用开发者预览版中包含的功能并提供反馈。但是，请注意不要在生产环境中部署它们来运行关键业务流程，因为这些版本需要进一步的稳定和测试。

## 访问 Oracle 数据的更简单方法

对于许多组织来说，Oracle 数据库是其数据资产的核心。几十年来，开发人员在这个核心架构之上创建了一个又一个系统。几乎每个开发人员都面临着在 Oracle 数据库中存储企业信息的需求。充分利用存储在那里的数据对每个企业来说都变得至关重要。

分布在混合云中的系统必须处理大量数据。这些数据的[复杂性](https://blog.christianposta.com/microservices/the-hardest-part-about-microservices-data/)使得[很难处理](https://whatis.techtarget.com/definition/data-gravity)，需要创建专门的数据管道。如今，业务应用程序经常需要访问存储在 ORDERS 或 CUSTOMERS 表中的数据的最新更新。在过去，创建这种类型的数据管道的选择很少。它们包括通过 Java 数据库连接(JDBC)查询数据，以及使用昂贵的专有技术来捕捉这些变化。

## 使用 Debezium connector for Oracle 对数据库进行流式处理

Debezium 是一组分布式服务，它捕获行级别的数据库更改，以便应用程序可以看到并响应这些更改。Debezium 连接器将所有事件记录到红帽 AMQ 流 Kafka 集群。应用程序使用 AMQ 流来消费变更事件。Debezium 变更数据捕获(CDC)方法使用事务日志来[避免来自应用程序的双重写入](https://debezium.io/blog/2019/02/19/reliable-microservices-data-exchange-with-the-outbox-pattern/)，这可能会导致数据不一致。Debezium 被设计成使用[数据库事务日志](https://debezium.io/blog/2018/07/19/advantages-of-log-based-change-data-capture/)，这样它将发出每个变更事件的记录。相比之下，使用基于轮询的方法，可能会错过查询之间的更改。

该连接器可以监视和记录 Oracle server 版本 12R2 和更高版本的数据库中的行级更改。Debezium 使用 Oracle 的本地 LogMiner 数据库包接收变更事件。Oracle LogMiner 是 Oracle 数据库实用程序的一部分，它为查询在线和归档重做日志文件提供了一个定义良好、易于使用的全面界面。

Debezium Oracle 连接器第一次启动时，它会执行数据库的初始一致快照，以查看其整个历史。您可以通过设置`snapshot.mode`来改变这种行为。连接器完成其初始快照后，Debezium 连接器继续从重做日志中它从当前系统更改号(SCN)位置读取的位置开始传输。初始快照确保连接器拥有完整一致的数据集。

考虑库存数据库模式中定义的客户表:

```
CREATE TABLE customers (

  id NUMBER(9) GENERATED BY DEFAULT ON NULL AS IDENTITY (START WITH 1001) NOT NULL PRIMARY KEY,

  first_name VARCHAR2(255) NOT NULL,

  last_name VARCHAR2(255) NOT NULL,

  email VARCHAR2(255) NOT NULL UNIQUE

);

```

连接器产生的所有数据更改事件都有一个键和值，尽管键和值的结构取决于源表。事件的键有一个模式，该模式包含表的主键(或唯一键约束)中每一列的一个字段。事件的值包含行的`ID`、`FIRST_NAME`、`LAST_NAME`和`EMAIL`列，其表示取决于列的 Oracle [数据类型](https://debezium.io/documentation/reference/connectors/oracle.html#oracle-data-type-mappings)。对于已删除的行，事件为使用者提供处理行移除的信息。

## 设置您的 Oracle 数据库

使用带有容器数据库的多租户配置，通过完成以下步骤来准备数据库:

1.  准备数据库并用您的预期值替换大小；例如:`10G`:

    ```
    ORACLE_SID=ORACLCDB dbz_oracle sqlplus /nolog

    CONNECT sys/top_secret AS SYSDBA

    alter system set db_recovery_file_dest_size = <REPLACE_WITH_YOUR_SIZE>;

    alter system set db_recovery_file_dest = '/opt/oracle/oradata/recovery_area' scope=spfile;

    shutdown immediate

    startup mount

    alter database archivelog;

    alter database open;

    -- Should now "Database log mode: Archive Mode"

    archive log list

    exit;

    ```

2.  为捕获的表或数据库启用补充日志记录，以便您可以捕获已更改的数据库行

    ```
    ALTER DATABASE ADD SUPPLEMENTAL LOG DATA;

    ALTER TABLE inventory.customers ADD SUPPLEMENTAL LOG DATA (ALL) COLUMNS;

    ```

    的状态之前的
**   设置具有特定权限的用户帐户，以便连接器可以捕获变更事件:

    ```
    sqlplus sys/top_secret@//localhost:1521/ORCLCDB as sysdba

      CREATE TABLESPACE logminer_tbs DATAFILE '/opt/oracle/oradata/ORCLCDB/logminer_tbs.dbf'

        SIZE 25M REUSE AUTOEXTEND ON MAXSIZE UNLIMITED;

      exit;

    sqlplus sys/top_secret@//localhost:1521/ORCLPDB1 as sysdba

      CREATE TABLESPACE logminer_tbs DATAFILE '/opt/oracle/oradata/ORCLCDB/ORCLPDB1/logminer_tbs.dbf'

        SIZE 25M REUSE AUTOEXTEND ON MAXSIZE UNLIMITED;

      exit;

    sqlplus sys/top_secret@//localhost:1521/ORCLCDB as sysdba

      CREATE USER c##dbzuser IDENTIFIED BY dbz

        DEFAULT TABLESPACE logminer_tbs

        QUOTA UNLIMITED ON logminer_tbs

        CONTAINER=ALL;

      GRANT CREATE SESSION TO c##dbzuser CONTAINER=ALL;

      GRANT SET CONTAINER TO c##dbzuser CONTAINER=ALL;

      GRANT SELECT ON V_$DATABASE to c##dbzuser CONTAINER=ALL;

      GRANT FLASHBACK ANY TABLE TO c##dbzuser CONTAINER=ALL;

      GRANT SELECT ANY TABLE TO c##dbzuser CONTAINER=ALL;

      GRANT SELECT_CATALOG_ROLE TO c##dbzuser CONTAINER=ALL;

      GRANT EXECUTE_CATALOG_ROLE TO c##dbzuser CONTAINER=ALL;

      GRANT SELECT ANY TRANSACTION TO c##dbzuser CONTAINER=ALL;

      GRANT LOGMINING TO c##dbzuser CONTAINER=ALL;

      GRANT CREATE TABLE TO c##dbzuser CONTAINER=ALL;

      GRANT LOCK ANY TABLE TO c##dbzuser CONTAINER=ALL;

      GRANT ALTER ANY TABLE TO c##dbzuser CONTAINER=ALL;

      GRANT CREATE SEQUENCE TO c##dbzuser CONTAINER=ALL;

      GRANT EXECUTE ON DBMS_LOGMNR TO c##dbzuser CONTAINER=ALL;

      GRANT EXECUTE ON DBMS_LOGMNR_D TO c##dbzuser CONTAINER=ALL;

      GRANT SELECT ON V_$LOG TO c##dbzuser CONTAINER=ALL;

      GRANT SELECT ON V_$LOG_HISTORY TO c##dbzuser CONTAINER=ALL;

      GRANT SELECT ON V_$LOGMNR_LOGS TO c##dbzuser CONTAINER=ALL;

      GRANT SELECT ON V_$LOGMNR_CONTENTS TO c##dbzuser CONTAINER=ALL;

      GRANT SELECT ON V_$LOGMNR_PARAMETERS TO c##dbzuser CONTAINER=ALL;

      GRANT SELECT ON V_$LOGFILE TO c##dbzuser CONTAINER=ALL;

      GRANT SELECT ON V_$ARCHIVED_LOG TO c##dbzuser CONTAINER=ALL;

      GRANT SELECT ON V_$ARCHIVE_DEST_STATUS TO c##dbzuser CONTAINER=ALL;

      exit;

    ```* 

## *部署 Debezium Oracle 连接器*

 *目前，Red Hat 没有发布 Oracle JDBC 驱动程序，但是您可以下载 Oracle 即时客户端来获得它。

以下示例显示了注册 Debezium Oracle 连接器实例的 JSON 请求:

```
{

    "name": "inventory-connector",

    "config": {

        "connector.class" : "io.debezium.connector.oracle.OracleConnector",

        "tasks.max" : "1",

        "database.server.name" : "server1",

        "database.user" : "c##dbzuser",

        "database.password" : "dbz",

        "database.url": "jdbc:oracle:thin:@(DESCRIPTION=(ADDRESS_LIST=(LOAD_BALANCE=OFF)(FAILOVER=ON)(ADDRESS=(PROTOCOL=TCP)(HOST=<oracle ip 1>)(PORT=1521))(ADDRESS=(PROTOCOL=TCP)(HOST=<oracle ip 2>)(PORT=1521)))(CONNECT_DATA=SERVICE_NAME=)(SERVER=DEDICATED)))",

        "database.dbname" : "ORCLCDB",

        "database.pdb.name" : "ORCLPDB1",

        "database.history.kafka.bootstrap.servers" : "kafka:9092",

        "database.history.kafka.topic": "schema-changes.inventory"

    }

}

```

有关连接器属性的更多信息，请参见 [Debezium 文档](https://debezium.io/documentation/reference/connectors/oracle.html#oracle-connector-properties)。

## Apache Kafka 的 Red Hat Integration Debezium 连接器入门

Debezium Apache Kafka 连接器可通过 Red Hat Integration 获得，它提供了一套全面的集成和消息传递技术，可以跨混合基础架构连接应用程序和数据。这个敏捷的、分布式的、容器化的、以 API 为中心的产品提供了服务组合和编排、应用程序连接和数据转换、实时消息流、变更数据捕获和 API 管理。所有这些都与云原生平台和工具链相结合，以支持现代应用程序开发的所有方面。

从 Red Hat Developer 下载 Red Hat Integration Debezium CDC 连接器开始。

*Last updated: October 14, 2022**