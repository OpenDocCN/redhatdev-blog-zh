# OpenID 连接与 Red Hat 3scale API 管理和 Okta 的集成

> 原文:[https://developers . red hat . com/blog/2020/11/09/OpenID-connect-integration-with-red hat-3 scale-API-management-and-okta](https://developers.redhat.com/blog/2020/11/09/openid-connect-integration-with-red-hat-3scale-api-management-and-okta)

This article introduces you to using [Red Hat 3scale API Management](https://developers.redhat.com/products/3scale/overview) for [OpenID Connect (OIDC)](https://openid.net/connect/) integration and compliance. Our goal is to secure an API in 3scale API Management using [JSON Web Token](https://jwt.io) (JWT), OIDC, and the [Oauth2 Authorization Framework](https://tools.ietf.org/html/rfc6749). We will set up the integration using [Okta](https://www.okta.com/) as our [third-party OpenID Connect identity provider](https://developers.redhat.com/blog/2018/10/09/3scale-3rd-party-idp-oidc/). An important part of the demonstration is establishing the 3scale API Management gateway's connection with Okta.

**注意**:这篇文章不是对 OIDC 或 Oauth2 的深入探究。我不会讨论认证和授权流程的细节。在本文的最后，您将看到如何获得一个访问令牌，您将需要这个令牌来对一个受保护的 API 执行请求。

## 先决条件

For demonstration purposes, we will use 3scale API Management and Okta as self-managed services. If you don't have them already, begin by creating free service accounts using [3scale.net](https://www.3scale.net/) and [okta.com](https://www.okta.com/).

## 设置 3scale API 管理 OIDC 集成

Our first step is to create the simplest possible REST API for integration. We'll use the 3scale API Management platform and an API back end configured to the `echo-api`: [https://echo-api.3scale.net:443](https://echo-api.3scale.net:443). As an alternative to this setup, you could try a different back end or a self-managed [APIcast instance](https://access.redhat.com/documentation/en-us/red_hat_3scale_api_management/2.3/html/deployment_options/apicast-overview). This article showcases OIDC authentication. You can adapt different settings to the use case. Figure 1 shows the OIDC settings in 3scale API Management. [caption id="" align="aligncenter" width="633"][![The dialog screen to enter the 3scale API Management OIDC settings for Okta authentication.](../Images/536919f996a95f6c3429352983bca6cf.png)](https://developers.redhat.com/blog/wp-content/uploads/2020/08/3scale-authentication-oidc-settings-1024x693.png) Figure 1: Enter the 3scale API Management OIDC settings for Okta authentication.[/caption] Note that the settings include AUTHENTICATION, AUTHENTICATION SETTINGS, and OPENID CONNECT (OIDC) BASICS. The OpenID Connect issuer URL is set to an Okta custom authorization server named "default." It is impossible to customize an [Okta default authorization server](https://developer.okta.com/docs/concepts/auth-servers/), so we will use the custom server for this example.

## 3scale API 管理 Okta 集成概述

So far, we have employed OpenID Connect's `.well-known/openid-configuration` endpoint to connect 3scale API Management with Okta. The 3scale API Management gateway determines what it needs from the OpenID Connect issuer URL, which we've just defined. Before going further, let's clarify what we want to accomplish. The diagram in Figure 2 illustrates the step-by-step process for integrating 3scale API Management and Okta. [caption id="" align="aligncenter" width="640"][![A diagram of the 3scale API Management and Okta integration.](../Images/8832bb96a4ea18ac26a50d78fe1c7a97.png)](https://developers.redhat.com/blog/wp-content/uploads/2020/08/3scale-oidc-okta-1024x575.png) Figure 2: An overview of the 3scale API Management and Okta integration.[/caption] Our goal is to call a protected API resource from 3scale API Management and use Okta for the user-delegated access.  **Step 1** assumes that we've retrieved a JSON web token from the Okta authorization server, as defined in the [OIDC specification](https://openid.net/specs/openid-connect-core-1_0.html#Authentication). We will experiment with the OIDC authorization flow later. After calling the API in **Step 2**, 3scale API Management verifies the JSON web token in **Step 3**. If the token is valid, 3scale API Management dispatches the request to the server back end, which you can see in **Step 4**. Verifying the client application ID is paramount for the request to be successful. In the next sections, we will look closely at the mechanics of verification.

## 验证并匹配 JWT 的说法

The 3scale API Management gateway secures every request by checking its associated JSON web token for the following characteristics:

*   **完整性**:JWT 是否被恶意用户篡改(签名检查)？
*   **过期**:这个令牌过期了吗？
*   **颁发者**:是否由 3scale API 管理网关已知的授权服务器颁发？
*   **客户端 ID** :令牌是否包含与 3scale API 管理网关已知的客户端应用 ID 相匹配的声明？

The next step is to match the 3scale API Management client with the correct JWT claim. In the 3scale API Management settings, set the **ClientID Token Claim** field to **appid**, as shown in Figure 3. [caption id="" align="aligncenter" width="573"][![The dialog to set the ClientID Token Claim.](../Images/7ff7664ce4380a3b1518d67c72f9aadc.png)](https://developers.redhat.com/blog/wp-content/uploads/2020/08/3scale-clientid-token-claim-1024x324.png) Figure 3: Set the ClientID Token Claim to `appid`.[/caption] This configuration tells 3scale API Management which claim to match against a client application in its API. For this demonstration, I decided to use `appid` rather than the default `azp` claim. The Okta authorization server requires a custom claim. I also wanted to avoid the often [misunderstood and misused azp claim](https://bitbucket.org/openid/connect/issues/973).

## 配置 Okta

Next, let's head over to the Okta admin portal to configure the Okta authorization server and OpenID Connect application. This configuration allows a client application to request a JSON web token on behalf of a user. Recall that we’re using a custom authorization server (named default) to add the `appid` JWT claim. The value assigned to this claim will be the Okta client application ID.

### 配置 Okta 授权服务器

As shown in Figure 4, we use the **Authorization Servers** dialog to add a new claim to the default authorization server. [caption id="" align="aligncenter" width="573"][![The Authorization Servers dialog in Okta admin includes the option to add the appid claim to Okta's default authorization server.](../Images/92cacf02d011f1fce1d685c52c1d38cd.png)](https://developers.redhat.com/blog/wp-content/uploads/2020/08/okta-auth-server-appid-claim-1024x589.png) Figure 4: Add the appid claim to the default authorization server.[/caption] In OpenID Connect, two tokens are usually issued in response to the authorization code flow: The ID token and the access token. We will use the access token to access the protected resource from 3scale API Management, so we only need to add the custom claim to that token type.

### 创建 OIDC 应用程序

While in the Okta admin portal, we'll use the OpenID Connect sign-on method to create a new application. Figure 5 shows the dialog to create a new application integration. [caption id="" align="aligncenter" width="573"][![The dialog to create a new application in the Okta admin portal. The OpenID Connect sign-on method is selected.](../Images/8708669dc68df9428e93673588caec32.png)](https://developers.redhat.com/blog/wp-content/uploads/2020/08/okta-oidc-create-application-preview-768x437.png) Figure 5: Select the option to create an OpenID Connect application.[/caption] Next, we use the **Create OpenID Connect Integration** dialog to create the application, as shown in Figure 6.  Note that we'll use the login redirect URI to retrieve the token later as part of the authorization flow. [caption id="" align="aligncenter" width="573"][![Use the 'Create OpenID Connect Integration' dialog to create the Okta app.](../Images/656087d9b2ba2c42c93312f3ff71d5a0.png)](https://developers.redhat.com/blog/wp-content/uploads/2020/08/okta-oidc-create-application-768x729.png) Figure 6: Create the OpenID Connect application for Okta.[/caption] After creating the OIDC application, locate the Okta-generated client ID on the **Client Credentials** page, shown in Figure 7\. Save this value to use when we create the corresponding client application in 3scale API Management. [caption id="" align="aligncenter" width="573"][![The Client ID generated by Okta is located on the Client Credentials page.](../Images/27d725f8e2c7029bc9c43ca80fabd3c1.png)](https://developers.redhat.com/blog/wp-content/uploads/2020/08/okta-oidc-create-application-details-768x348.png) Figure 7: Locate the client ID on the Okta admin Client Credentials page.[/caption]

### 创建用户并将其分配给 OIDC 应用程序

The last thing we'll do in Okta is to create and assign at least one user to the application, as shown in Figure 8\. This allows a valid login to execute using the OpenID Connect authorization flow. [caption id="" align="aligncenter" width="573"][![In the Okta admin console, create and assign at least one user to the application.](../Images/ba94f58e1a7bb36e1660efa0e7abc083.png)](https://developers.redhat.com/blog/wp-content/uploads/2020/08/okta-app-assign-user-768x367.png) Figure 8: Create and assign at least one user to the OpenID Connect application in Okta.[/caption] This completes the Okta configuration. Next, we will configure a corresponding application in 3scale API Management.

## 配置 3scale API 管理客户端应用程序

The API gateway can only authorize API calls from a previously registered client application. So, our last step is to create a 3scale API Management application whose credentials match with the application we've just created in Okta. We only need to match the `application_id` (also called the client ID), because it is carried by the JWT `appid` claim. As an admin user, navigate to the 3scale API Management docs. You must use [3scale API Management](https://www.redhat.com/en/technologies/jboss-middleware/3scale) to create the client application and specify a user-defined `application_id`. Figure 9 shows the dialog to create the 3scale API Management client application. [caption id="" align="aligncenter" width="573"][![Create the client application using the 3scale API Management gateway API.](../Images/fb79b432308ba77526e74ec640ad5898.png)](https://developers.redhat.com/blog/wp-content/uploads/2020/08/3scale-create-application-via-api-1024x630.png) Figure 9: Use the 3scale API Management gateway API to create a client application.[/caption] Once you have it set up with the correct parameters, you will see the new application in the listing that subscribes to the API product you are testing.

## 测试应用程序

Now, you might wonder how to ensure that the 3scale API Management application performs correctly. In this case, we can use Postman to execute a request with a valid JWT access token from Okta. The screenshot in Figure 10 shows how to execute the authorization flow in Postman. [caption id="" align="aligncenter" width="573"][![Using Postman to get a JWT access token from Okta.](../Images/2af888035dc67a75b37917be3065418b.png)](https://developers.redhat.com/blog/wp-content/uploads/2020/08/postman-authorization-get-token-768x784.png) Figure 10: Using Postman to get a JWT access token from Okta.[/caption] A login screen should pop up, followed by the successful retrieval of the ID and access tokens. Then, we can successfully retrieve the client ID and access tokens shown in Figure 11\. (Note that the access token is represented using [jwt.io](https://jwt.io).) [caption id="" align="aligncenter" width="640"][![Represents the JWT access token from Okta using jwt.io](../Images/4aa896a9b5e177a6cf6a4ba66cb6967e.png)](https://developers.redhat.com/blog/wp-content/uploads/2020/08/okta-access-token-example-1024x580.png) Figure 11: Retrieve the client ID and access tokens from Okta.[/caption] From here, we call the API endpoint with the JWT access token assigned to the `Authorization: Bearer` HTTP request header:

```
$ curl "https://some-example-api.xyz.gw.apicast.io" -H "Authorization: Bearer jwt-access-token-base64"
```

Postman can take care of the rest. The `echo-api` will respond when the authentication is successful.

## 使用 Red Hat 的单点登录技术进行 OIDC 集成

For this demonstration, we had to create an OpenID Connect application in both Okta and 3scale API Management. The number of applications grows as you start to delegate the process of application creation to other developers. The one OIDC specification that addresses this problem is the [Dynamic Client Registration specification](https://openid.net/specs/openid-connect-registration-1_0.html). At the time of this writing, 3scale API Management and Okta don't automatically integrate. However, Red Hat's [single sign-on technology](https://access.redhat.com/articles/2342881) is an open-source OpenID provider that integrates seamlessly with 3scale API Management. You can use the 3scale API Management gateway and the [single sign-on developer portal](https://access.redhat.com/documentation/en-us/red_hat_3scale_api_management/2.7/html/creating_the_developer_portal/authentication) to drive the authorization flow. Find out more about [Red Hat single sign-on tools (7.4)](https://access.redhat.com/documentation/en-us/red_hat_single_sign-on) and its upstream community project [Keycloak.](https://www.keycloak.org/)

## 结论

Thank you for taking the time to read this article and follow the demonstration. As you have seen, 3scale API Management works together with any OpenID provider in a way that is compliant with its specification. We've used Okta as our OpenID provider for this demonstration. I hope that breaking down the verification process and showing each party's roles and responsibilities helped to demystify aspects of application security with JWT, OIDC, and Oauth2. *Last updated: May 13, 2021*