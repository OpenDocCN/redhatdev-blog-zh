# Red Hat 如何将 OpenJDK 移植到 64 位 Arm:社区历史

> 原文：<https://developers.redhat.com/blog/2021/02/01/how-red-hat-ported-openjdk-to-64-bit-arm-a-community-history>

对于为计算机处理器设计精简指令集计算(RISC)架构的 Arm 有限公司来说，这是不平凡的一年。基于 Arm 的计算机在可预见的未来将会很重要的消息甚至传到了主流媒体。2019 年底，亚马逊网络服务宣布基于 Arm 的 Graviton2 服务器。2020 年 6 月，苹果宣布计划将麦金塔电脑转移到苹果芯片上——这意味着 Arm。

对于我们这些在 Arm 服务器上工作多年的人来说，这种转变已经到来很久了。

## 起初

回到 2011 年的一天。我和 Red Hat 的首席手臂设计师乔恩·马斯特斯(Jon Masters)在摔跤手餐厅(剑桥英国技术社区最受欢迎的泰国餐馆)共进午餐。他有令人兴奋的消息要分享:Arm 将生产 64 位架构，Red Hat 将向其移植 Red Hat Enterprise Linux(RHEL)。要完成这项工作，我们需要解决相当多的问题，但有一个特别困难。当时可用于新 64 位架构的软件不包括 [Java](https://developers.redhat.com/topics/enterprise-java) 。Java 是许多企业软件的关键组成部分，所以这个消息是一件大事。

有人必须写一个端口。我听说两个专家可以在大约一年的时间内编写出一个 OpenJDK 的基本端口，但我只知道这些。如果我的团队要做这件事，我们必须在工作中学习。

我很高兴能全力以赴完成这样一项重要的工作，但是在没有成功保证的情况下，Red Hat 怎么能证明开始这个大项目是正当的呢？我争辩说，除非我们这样做，否则我们必须付钱给某人。那要花很多钱，所以为什么不自己做来省钱呢？这将是很好的宣传，我们可以建立联盟。但是还有一个更深层次的原因让它留在内部。我们已经为 OpenJDK 建立了一个支持团队。通过编写一个完整的端口，我们可以获得通过其他方式无法获得的经验。Red Hat 的管理层同意了(并且一直支持这个项目)，所以我们准备好了。

我决心成为这个项目的工程师之一，但我无法独自完成。幸运的是，Andrew Dinn 即将加入我们的 Java 团队。他研究 Java 已经有很长时间了，并且拥有为 Lisp 机器和逻辑语言编写编译器的经验。他很适合。

有一件事让我很担心:如果别人先做了港口呢？那么所有的努力，连同所有的荣誉都将付之东流。防止这一灾难的唯一方法是获得先发优势，公开开展工作。快做好，做好，免费。建造它，他们会来的。

## 开始项目

我们确实有一个问题——或者说，两个问题。首先，当时没有 AArch64 处理器。此外，说服 Arm 有限公司给我们所需的详细信息并不容易。Arm 的 Philippe Robin 的坚持和帮助解决了文档问题，但硬件的缺乏更加困难。在模拟下运行所有 OpenJDK 是可能的，但是当时的模拟器非常慢。更糟糕的是，OpenJDK 还得向操作系统调出。在启动 Java 之前，我们需要在模拟器上引导所有的 Linux。

安德鲁·丁纳记得我们在一次会议上吃早餐时，我兴奋地告诉他，那天早上洗澡的时候，我已经想好该做什么了。我们将使用一个简单的、功能性的指令集模拟器，但是只针对我们自己生成的 AArch64 代码。OpenJDK JVM 的其余部分是 C++。我们可以在基于英特尔 x86 的电脑上全速运行。从 C++到 Java 的每个调用都会进入模拟器，而从 Java 到 C++的每个调用都会离开模拟器并返回 x86 代码。但是我们从哪里得到一个 AArch64 模拟器库呢？“我们会写一个，”我说。“这是一个 RISC。能有多难？”

我们从 2012 年 6 月开始。Andrew Dinn 花了一点时间编写模拟器，而我继续编写汇编程序和初始启动代码。几个月后，我们开始执行 Java 字节码。编写我们自己的模拟器的想法受到了启发。我们可以创建复杂的断点条件，甚至记录指令跟踪，这样我们就可以在 JVM 崩溃时看到指令历史。因此，最初的移植进行得很快。回头看日志，我看到一个条目“足够了，你好，世界！”2012 年 10 月 4 日。这是一个重要的日子:输出“你好，世界！”对于控制台来说，Java 必须在不崩溃的情况下执行大约 75 万个字节码，并运行大部分虚拟机。

## 还剩三个

到 2013 年夏天，我们中有三个人在做这个项目。Edward Nevill 是 Arm 公司的 Java 专家，他从 Linaro 加入了这个项目。他是第一个得到实际硬件的人。我对我们的小 AArch64 模拟器非常满意，所以我很高兴有人能在真机上调试我们的工作。我预料这将是一个痛苦的过程。但是，除了刷新指令缓存的一个小问题和浮点标志的一个问题之外，它都工作了！我很惊讶。我们根据 Arm 的文档编写了自己的模拟器、编译器和汇编器。我们没有独立的证据，但是我们得到了正确的答案。

爱德华帮了我们很大的忙，到 2014 年初，我们有了一个可以使用的港口。Red Hat 开始向我们的合作伙伴发布早期版本，我们和其他人继续修复 bug 并提高性能，2015 年 3 月 2 日，AArch64 端口成为主要 OpenJDK 项目的一部分。甲骨文很棒，在棘手的整合过程中帮助并鼓励了我们。

## 整合和(非常)长尾

工作中的 JVM 和真正好的 JVM 之间有很大的区别。不知道在 Intel/x86 OpenJDK 上花了多少时间，但肯定是几十个工程师年。让 AArch64 港口具有竞争力对我们来说是一个真正的挑战，但我们得到了帮助。来自 AArch64 硅生产商和其他公司的人们加入了我们，现在来自世界各地的人们正在港口工作。

这就是 Red Hat 的开放和协作方法真正带来回报的地方。通过与他人建立伙伴关系，我们比纯粹的内部软件开发获得了更大的收益。

但这还不是故事的全部。我们听说 Oracle 在 64 位 Arm 上运行 Java，我想知道这是不是我们的移植。事实证明，该端口是专有的，基于 Oracle 已经拥有的(32 位)Arm 端口。我担心 Java 的创始人会获得比我们更好的性能。最终，某个使用过 Oracle 端口的人好心地向我保证，我没什么好担心的。然而，我觉得奇怪的是 Oracle 写了一个自己的端口。公司从一开始就被允许使用我们所有的代码。为什么要再写一遍？

最终，Oracle 释放了其 Arm 32 位和 64 位端口。这给我们留下了 OpenJDK 中的两个 AArch64 端口。然后，在 2020 年 11 月 12 日，甲骨文[宣布](https://blogs.oracle.com/java-platform-group/update-on-64-bit-arm-support-for-oracle-openjdk-and-oracle-jdk)它已经决定将其资源集中在一个 64 位 Arm 端口上:我们在 Red Hat 开始的 AArch64 端口。Oracle JDK 8 维护版中的 64 位 Arm 支持现在也基于我们的端口。

最近，苹果公司大惊小怪地宣布了苹果 M1 芯片，这是 AArch64 的一种实现。OpenJDK 已经为该处理器做好了准备，而且已经准备了五年。然而，有一层 OpenJDK 是特定于每个 OS-CPU 组合的。总得有人做这项工作，我们很快就有了两个志愿者:微软和 Azul，他们一起工作。微软还将 OS-CPU 层移植到了 Windows/AArch64 上。

## 结论

那么，为什么会发生这一切呢？OpenJDK 开发人员社区做出了决定。我相信这是因为我们的小团队很早就推出了一个工作端口，将它纳入了 OpenJDK 主线，并欢迎所有想要参与的人。我们保持尽可能多的公开讨论。人们自愿加入，我们变成了一个社区。我们在这个社区取得的成就远远超过了我们自己的期望。但是，如果我们没有在 2014 年初释放那个工作端口，这一切都不会发生。

*Last updated: January 29, 2021*