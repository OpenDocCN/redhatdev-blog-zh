# 背包中的云实验室环境

> 原文:[https://developers . red hat . com/blog/2018/04/09/cloud-lab-environment](https://developers.redhat.com/blog/2018/04/09/cloud-lab-environment)

有没有想过拥有自己的云环境？本地云是您可以更好地了解高生产力环境中运行的所有设备的最佳方式之一。我怎么知道？我做到了！我准备好向你展示我是如何做到的，你也可以做到。

哔哔。警报刚刚响起。现在是凌晨 4 点，我甚至感觉不到自己的想法。我必须安静地离开。幸运的是，机场离家不远。

我经常在全国各地旅行，展示很多关于 DevOps 的东西，重点是 [Red Hat OpenShift 容器平台](https://developers.redhat.com/products/openshift/overview/)。这是一项伟大的工作，但也有风险。由于我不知道我将不得不展示的确切环境是什么，我不断被许多挑战包围:充满策略和代理的网络，没有可靠移动互联网接入的建筑物，超过移动配额，糟糕的酒店互联网接入；这个名单还在不断增加。云上有很多资源，如果我连不上云，也解决不了我的问题。这容易酿成大祸。

我不能依赖云提供商。我必须成为自己的云提供商。

我有一个很好的朋友，他碰巧和我一样是数字流浪者。他是有史以来最好的同伴之一。有一天，我们在网上寻找“类固醇覆盆子”。在发现了许多微小而强大的设备后，他发现了我们的赢家:英特尔 Nuc Skull Canyon。

我告诉他:“总有一天我会有一个这样的东西。想象一下，来到客户现场展示这款可爱的硬件会有多棒。”

这并不是克劳迪奥第一次发现一个伟大的硬件。我一直在用他推荐的一款 [GL.iNet](http://gl-inet.com/) 路由器(GL-AR300M 型号)。但 Nuc 是克劳迪奥最大的发现。它立刻成为我购物清单上最优先的项目。经过几个月的储蓄，我终于能够购买一个具有惊人的 32GB 内存和 1TB 固态硬盘的 Nuc。下一步应该很简单:在上面运行 Red Hat OpenShift。

一开始，我用的是经典的`oc cluster up`。它催生了一个不可阻挡的野兽，在这样的硬件上运行非常流畅。速度很快，但不好玩。尤其是因为度量和日志记录不起作用。deployer pods 中的一些问题阻碍了他们的成功。我最终写了一个 [Red Hat Ansible Automation](https://www.redhat.com/en/technologies/management/ansible) 剧本来使用`oc debug`命令修复这些问题。它很实用，但绝对不好玩。

对我来说，Red Hat OpenStack Platform 听起来很有趣，但是通过 Red Hat OpenStack Director 在 Nuc 上安装它并不是一项可行的任务。所以，我选择了简单的[背包](https://wiki.openstack.org/wiki/Packstack)(请不要杀我)。

嗯……对于像我这样对网络几乎没有任何经验的开发人员来说，这并不容易。

经过大量的试错，我终于成功配置了红帽 OpenStack 平台。因为“东西”发生了，所以我写了一个剧本，用一个包含我玩它所需要的所有东西的实验室项目来引出它。然后我在 GitHub 上发布了全部内容。“好戏开始了。”

好吧！我有办法安装红帽 OpenStack 平台，但是安装红帽 Enterprise Linux 怎么样？一些网页后，我发现了蟒蛇的 Kickstart。这是自动化 RHEL 安装(以及通过 Anaconda 安装的任何其他 Linux 发行版)的一种方式。更好的是，RHEL 在每次安装后都会写一个 kickstart 文件。然后，您只需将文件复制并粘贴到名为 OEMDRV 的驱动器中。两个闪存驱动器(一个带有 RHEL 映像，另一个带有 Kickstart 文件)将触发自动安装。但是我不想用闪存盘，我有两个没用过的安卓设备。更有趣。

我从 2010 年开始使用安卓设备；我的第一个是运行 Android 1.5 的摩托罗拉淬火(纸杯蛋糕)。当我扎根于此，看到了无尽的可能性，我的思维打开了，我迷上了使用 Android 设备做任何事情。

我开始寻找一种将 Android 设备用作闪存盘的方法，这让我找到了令人敬畏的[drive droid；](https://play.google.com/store/apps/details?id=com.softwarebakery.drivedroid)这是一款模拟闪存盘和光驱的应用。我拿起我的手机，一个加载了 RHEL 的图像，另一个加载了 Kickstart 的图像，然后我把两个都插入了后面的 USB 端口。我不在乎电池，因为它们是旧手机。

于是我想:“现在我有两部手机；只是为了安装 RHEL？为什么我不把它们用在别的地方？”两个 Android 设备可以在设置上有所不同。我在两部手机上都安装了神奇的终极服务器，以减少 Nuc 的工作量。两台手机上的 Smb 共享允许我上传任何我想安装的新图像；这导致我放入一个 HTTP 服务器来为我的 Docker 映像提供安装文件。git 服务器将通过保存我的开源 Red Hat Ansible 自动化剧本的库存文件来完成剩下的工作。

最后，我将路由器插入 USB-C 端口。路由器需要一些时间来启动(比 Nuc 需要更多的时间)。这导致了 Nuc 的网络问题，因为 Red Hat OpenStack 平台需要禁用网络管理器，所以网络需要在 Nuc 启动之前可用。通过将路由器连接到 USB-C 端口，它可以在不打开 Nuc 本身的情况下通电。然后，我已经连接了所有电缆，并让 Nuc 准备就绪，只需插入电源。钩环紧固件完成了设计，将 Android 设备和路由器固定在 Nuc 的顶部。然后很容易把包裹放在一个小手提包里，我每次去机场都需要打开它，因为它在 x 光片上的图像类似于炸弹！我以最糟糕的方式发现了这一点。

用 Red Hat OpenStack 平台安装 RHEL(加上一个完整的工作项目)只需要七个步骤:

1.  在两部手机上运行 DriveDroid。
2.  打开 Nuc。
3.  等到推送通知到达我的主电话。
4.  关闭 DriveDroid。
5.  再次打开 Nuc。
6.  运行 Red Hat ansi ble Automation playbook 安装 Red Hat OpenStack 平台。
7.  等到第二个推送通知到达。

我的 Kickstart 脚本在将我的 ssh 公钥写入授权密钥并通过 [Pushover](https://pushover.net/) 发送通知后关闭了 Nuc。我使用 Pushover 已经有一段时间了；这是获得通知的直接方式。那第二条推送通知对我来说意义重大；它告诉我我的云环境已经准备好了。

[![](../Images/58a809d96eaacb8c186549731e15fe04.png "nuc")](/sites/default/files/blog/2018/03/nuc.png)My Portable Cloud">

我终于成为了自己的云提供商。有很多乐趣，没有一滴朗姆酒！

下一步，安装 Red Hat OpenShift 并不容易。在运行剧本时遇到许多问题后，我发现了问题。路由器(GL-AR300M)是一个很好的路由器，但它不是一个接收 PaaS 流量的路由器。所以我决定创建一个内部 DNS 作为 OpenStack 实例。

在我的笔记本电脑上，我使用的是外部 IP 地址。但是，在内部，实例将只使用内部 IP 地址而不是外部 IP 地址相互通信。对于像我这样的开发人员来说，这是一个典型的错误。

一切都解决了，我再次运行剧本…并得到了另一个错误。Red Hat OpenShift 无法与 Red Hat OpenStack 平台通信，因此无法在 Cinder 中创建卷以将其连接到运行 pod 的节点。问题在上游解决了；一行告诉 Red Hat OpenShift 使用 Red Hat OpenStack 块存储 API 的版本`v2`。所以我写了一个小的解决方案，将补丁应用到 OCP 3.7，并将所有东西打包到剧本中，推送到 [GitHub](https://github.com/devnull-tools/pack-your-lab/tree/master/openshift) 。随着 OCP 3.9 从上游应用补丁，我不再需要我的定制补丁，只需要常规的剧本。

行动手册可以创建所有实例，Docker 存储映射到 Cinder 卷，所有先决条件都已完成，并且创建了 Red Hat Ansible 清单文件，太棒了！只需一步，我就能调出一个 Red Hat OpenShift 集群。我在周末跑了很多次，只是为了看看事情进展如何。那是“超级好玩”！

随着云环境的完成，只需要为我的演示安装工具。但是环境太棒了，所以我决定把我自己的工作环境也带进来。我的演讲变成了真实的案例！

我不喜欢给开发者贴标签:后端、前端、全栈…，听起来像是不同类型的重金属音乐。都是关于编码的，但是一个人可以在某些领域有更多的专业知识。

我热爱编码，我尝试学习许多编程语言。他们是工具。如果你有合适的工作工具，你就能愉快地完成工作。这就是为什么我也喜欢编写工具来更好地完成我的工作。因此，我的工作环境很容易复制:一个 [GitLab](https://gitlab.com/) 实例和一个 [Nexus](https://www.sonatype.com/nexus-repository-sonatype) 存储库。但这并不意味着我没有价值流来交付我的工具。

我被 GitLab 的逃犯绑架了。太棒了！我的 [Gogs](https://gogs.io/) 实例倒下了，我再也没有回头。不要误解我，Gogs 是一个很棒的项目，但是 GitLab Runner 为我提供了最好的工具来完成我的工作(也就是乐趣)。

运行器是代码和价值流(管道)之间的连接。管道上的每一步都在一个容器内运行，这个容器是由 Red Hat OpenShift 上的 runner 创建的。我创建了一组构建映像，不仅用来编译代码，还用来发布代码。Pushover 告诉我关于我的管道的一切。现在一切都发生在一个奇妙而强大的整合中，帮助我吸引人们。

做一件事有成千上万种方法，但是你展示如何做的方式才是吸引人的。魔术就是这样变的！

一个好的纸牌魔术很简单。你如何让人们选一张牌，或者你洗牌洗得有多好，都无关紧要。最后，关键在于你如何揭示底牌。如果你做对了，那将是难忘的。

我喜欢纸牌魔术！你可以很容易地用一个好的技巧吸引观众，这就是我现在做演讲的方式。他们不指望我拿出一个小装置，就能让整个环境为之震撼。这是我的绝招！趣味计时器爆炸了！

哦！我的出租车快到了，我应该喝完我的咖啡。我有一个演示要做…而最好的环境现在就在我身边。

*Last updated: September 3, 2019*