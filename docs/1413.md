# 链路建模、网络仿真及其对应用的影响

> 原文:[https://developers . red hat . com/blog/2017/08/31/on-link-modeling-network-emulation-and-its-impacts-on-applications](https://developers.redhat.com/blog/2017/08/31/on-link-modeling-network-emulation-and-its-impacts-on-applications)

在这篇博文中，我将向您介绍定义分组交换网络中“链路”的最重要特征，它们如何影响您的应用，给出一些真实参数的例子，以及如何使用 NetEm 来模拟它们。

在每一个分组交换网络中，你会注意到它们固有的特性，这些特性随所使用的通信信道而变化。这些特征是带宽、延迟(包括抖动)、分组丢失、分组损坏和重新排序。

带宽可能是最广为人知的一个原因，尽管仍然经常被错误地归咎于糟糕的在线体验**。实际上，上面的任何特征都会影响用户体验，在某种程度上取决于它们有多大。**

 **在具有多跳的网络(如互联网)上，给定路径的可用**带宽**是由其中最小的可用带宽给出的，很像两个城市之间的高速公路。如果某个特定的跳发生拥塞，即使它看起来很小，对用户体验的影响也可能超过他/她的连接本身。

**延迟**是网络强加的所有延迟的总和。网络上有 4 种延迟:传输延迟、传播延迟、处理延迟和缓冲延迟，它们发生在网络的每一跳，达到不同的程度。

**传输延迟**是系统实际传输一个包需要多少时间。假设一个 1500 字节的数据包是串行输出的，那么在不考虑开销的情况下，无论另一个端点离它有多远，它至少需要 12us 才能以 1GBps 的速率输出。

然后是**传播延迟**，即输出信号传播到另一个端点所需的时间。举个粗略的例子，在光纤中传输 2 公里的时间延迟接近 10 微秒。从旧金山到纽约，大约 4700 公里，大约 23 毫秒，如果你有一条直线光纤连接两个城市。

然后是**处理延迟**，这是一跳中的节点需要多少时间来识别到达的数据包，并知道它应该被发送到哪里。一些节点甚至可能在其上做一些其他工作，如 NAT 或防火墙，这也在这里说明。

最后，还有**缓冲延迟**。一个系统必须至少有一定级别的接收和发送缓冲区，才能满负荷运行，但有些系统(远远)不止这些。如果你的包到达了，而它的缓冲区中没有其他包，你就是下一个。但是可能已经有一些了，你可能要等一会儿才能继续。目前不建议使用过多的缓冲剂，因为它们可能会引发缓冲漂浮[6]效应。

![](../Images/80859aca77bafb7dbdda365c9c528c83.png)

在电缆连接中，前三个延迟源(传输、传播和处理)通常被认为是恒定的，尤其是与缓冲延迟相比时。有些人可能把它们的总和称为“等待时间”，或简称为“延迟”。最后一项，即缓冲延迟，被认为是抖动的主要成分。例如，当您考虑 Wi-Fi 连接时，由于信号强度和/或冲突和/或干扰，传输延迟也会浮动，这就变得更加复杂。这是因为 Wi-Fi 上使用的 PHY 层协议默认情况下会尝试重新传输数据包多达 6 次，导致该重新传输的数据包和队列中的所有其他数据包出现额外的延迟。因此，不管实际的源是什么，延迟是恒定部分，抖动是可变部分。通常两倍的延迟会导致往返时间:去和回去需要多少时间。

**丢包**可以有多个来源，所有的来源都会导致丢包。一种非常可能的情况是，当到达一跳时，由于缓冲区 中没有足够的空间，数据包不得不被丢弃。有一些主动队列管理，如 RED(随机早期丢弃)正在使用，它甚至可以在此之前丢弃数据包，因此它开始向每个人发出信号，表明它已达到其极限。分组丢失也可能是干扰的结果，尤其是在无线通信中。

**数据包损坏**要么是错误处理的结果，要么是某些干扰损坏了数据包中的一些位。以太网和 Wi-Fi 等链路层具有内置的检查功能，以避免此类损坏的数据包继续在网络上传输，因此现在当这种情况发生时，很可能是数据包被错误地处理了。

最后一个特点是**重新排序**。例如，当一跳决定现在最好通过不同于当前路径的另一路径发送分组时，可能会发生重新排序。如果这条新路径的延迟较小，那么在切换之后发送的第一个数据包很可能会在旧路径上发送的最后一个数据包之前到达。

# 应用程序以及网络对它们的影响

## 网站

现在回到用户体验。假设您正在开发一个网站，您公司的其他员工将使用该网站，但他们位于另一个大陆。当你测试网站时，它看起来很“快”。当他们测试它时，它是“慢”的。为什么，带宽？大概不会。加载一个网页，虽然现在看起来很简单，但对浏览器来说却是一项非常复杂的任务。

假设 DNS 已经被解析，它连接到网络服务器并下载页面的第一部分，如 index.html 文件。为了下载它，它必须打开一个 TCP 连接，发出一个 HTTP 请求并得到回复。所有这些至少需要 2 RTT(往返时间)。然后浏览器解析 HTML 文件，并注意到它必须下载一个 CSS 文件。使用 HTTP/1.1，它可以重用相同 TCP 连接，并将下载 CSS 文件的时间缩短到至少 1 RTT。

然后，当解析 CSS 时，它注意到它也必须下载一个图片，这个图片托管在另一个服务器上。所以它打开这个新的 TCP 连接，发出 HTTP 请求并下载图像，再次消耗至少 2 个 RTT。所以仅仅是这个，就花了至少 5 个 RTT。请注意，我们没有考虑文件有多大，因此带宽在这里无关紧要。如果两台服务器都在楼下，那就很快了。但是如果你有一个 200 毫秒的 RTT，这在洲际链接中很常见，那就是整整一秒钟！

即使你决定将 CSS 部分内联，那也只能节省 1 个 RTT，并且仍然面临 800 毫秒的页面加载时间。

你现在可能明白延迟对 HTTP 等请求/响应协议有多大的影响了。

上面的例子也没有考虑可能的数据包丢失，这可能会导致 TCP 为让您的数据通过而等待更长的时间，这种等待也可能与 RTT 有关。

这给我们带来了一个已知的问题，叫做行首阻塞[7]:当一个包(或一个请求)等待当前的包先完成时。对于 TCP 来说，由于它必须向接收应用程序传送数据，因此可能会因为数据包丢失或无序传送而发生这种情况。在 HTTP 层，当一个浏览器在同一个连接上发出两个或更多的请求，并且第一个请求比其他的大得多时，它将阻塞它们，直到它完成。有多种方法可以解决这个问题，比如 HTTP 管道[8]和/或使用 HTTP/2，它允许交叉回复。

## 视频流

如果你有一个流媒体应用，比如视频，事情就变了。实时观看安全摄像头至少需要一定的带宽，但如果 RTT 是 10 毫秒或 1 秒，您可能甚至不会注意到。

像网飞或 Youtube 这样的视频流使用一种叫做 DASH[5]的协议，它建立在 HTTP 之上。DASH 分块下载视频，并进行一定程度的缓冲，至少给你足够的时间下载下一个视频。此时，它将决定是否应该从更高或更低质量的流中下载，考虑剩余的缓冲区数量以及它认为下载下一个流需要多长时间。因此，延迟和抖动对体验的影响很小，但数据包丢失或损坏可能会导致下载数据块所需的时间比预期的长，从而导致性能下降。

## 交互式内容，如网络电话和游戏

对于 VoIP 来说，如果任何路径上的延迟超过 250ms，它就会变得很烦人，因为你不知道它是无声的，因为对方在等待你说话、思考或什么，所以你开始说话，突然对方也在说话。建议无论如何都不要大于 150ms。超过 40 毫秒的抖动也会导致性能下降。VoIP 应用通常只使用足够大的缓冲区来补偿启动期间检测到的抖动，因此它尽可能保持实时，尽管抖动变化大于它将导致流暂停。丢包也会导致性能下降，但是所使用的编解码器会说明它对某些丢包的容忍程度。

网络游戏。看是哪种游戏了。如果是网上象棋，你可能也没问题，只要关注网页本身就行了。对于第一人称射击游戏，你希望有尽可能低的延迟，最好是低抖动。

# 我能在实验室模拟这个吗？

为了这个目的，Linux 在相当长的一段时间里都有 tc 队列规则“netem”。Netem 能够模拟上述所有特性，甚至可以用于 net 名称空间之间的 veth 隧道，因此测试非常方便。它的联机帮助页非常详细，包含如何使用它们的命令示例。在 Linux Foundation 网站[1]上也有一个关于命令行参数的很好的教程，这里不值得重复。

## 但是我应该使用哪些值呢？？

这可能是故意被排除在联机帮助页之外的。每个环节都有其自身的特点，导致要使用的特定值。然后是多跳，这只不过是多个链接连接在一起，你可以有一些非常复杂的场景。幸运的是，如果这是你第一次使用这种类型的模拟，这可能意味着你不需要任何花哨的东西。您可以/应该从一个简单的配置开始，并在您认为合适的时候进行改进。

根据我的经验，以下是 WAN 链路的一些值，可以作为起点。一旦这些对你来说变得不够了，建议你寻找科学论文来获得更多的建议和/或自己测量。请注意，您还应该考虑剩余的路径，这些只是最后一英里。

WAN ADSL:延迟 6ms，掉线 0-1%，抖动 0.5ms

广域网光纤:2.2 毫秒延迟，0%掉线，抖动 0.1 毫秒

像 RNP.br 这样的一些机构似乎考虑:

损失< = 0.01%:优秀

0.01%<损耗< = 1%:良好

1% <损失< = 3%:常规

3% <损失:不良

你也可以在这里使用美国电话电报公司提供的信息。他们也提供当前状态和一些过去的数据[3，4]。在[2]中，我们可以看到从纽约到旧金山实际上需要 64 毫秒，目前的下降率为 0%。

[](https://wiki.linuxfoundation.org/networking/netem)

【2】[](http://ipnetwork.bgtmo.ip.att.net/pws/network_delay.html)

【3】[http://IP network . bgtmo . IP . att . net/pws/global _ network _ avgs . html](http://ipnetwork.bgtmo.ip.att.net/pws/global_network_avgs.html)

【4】[](http://ipnetwork.bgtmo.ip.att.net/pws/averages.html)

[5][https://en . Wikipedia . org/wiki/Dynamic _ Adaptive _ Streaming _ over _ HTTP](https://en.wikipedia.org/wiki/Dynamic_Adaptive_Streaming_over_HTTP)

[https://en.wikipedia.org/wiki/Bufferbloat](https://en.wikipedia.org/wiki/Bufferbloat)

[7][https://en.wikipedia.org/wiki/Head-of-line_blocking](https://en.wikipedia.org/wiki/Head-of-line_blocking)

[8][https://en.wikipedia.org/wiki/HTTP_pipelining](https://en.wikipedia.org/wiki/HTTP_pipelining)

* * *

**无论你是容器新手还是有经验的人，下载这个** [**备忘单**](https://developers.redhat.com/promotions/docker-cheatsheet/) **可以在遇到你最近没有完成的任务时帮助你。**

*Last updated: August 30, 2017***