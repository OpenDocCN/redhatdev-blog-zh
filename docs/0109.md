# 在 Red Hat 3scale API 管理中使用自定义指标策略

> 原文:[https://developers . red hat . com/articles/2021/05/25/capture-detailed-analytics-custom-metrics-policy-red-hat-3 scale-API-management](https://developers.redhat.com/articles/2021/05/25/capture-detailed-analytics-custom-metrics-policy-red-hat-3scale-api-management)

开发者使用[Red Hat 3 scale API Management](/products/3scale/overview)通过一个名为 [APIcast](https://access.redhat.com/documentation/en-us/red_hat_3scale_api_management/2.3/html/deployment_options/apicast-overview) 的网关来管理 API。APIcast 包括许多现成的[策略](https://access.redhat.com/documentation/en-us/red_hat_3scale_api_management/2.9/html/administering_the_api_gateway/apicast_policies#standard-policies)，可以对其进行配置以扩展其默认行为。APIcast 新增的自定义指标策略通过 3scale 分析引擎提供了另一种跟踪对您的业务有价值的指标的方法。

3scale API Management 2.9 中引入了自定义指标策略。我很想了解如何配置这个策略，并想了解它的潜在使用场景。本文介绍了一种利用定制度量策略的方法，使用跟踪特定 HTTP 响应状态代码的度量作为示例场景。3scale 中的默认分析只是将响应状态捕获到 2xx、4xx 等桶中。如果您想要捕获特定的状态代码，比如 203 或 403，您可以使用这个[自定义指标策略](https://access.redhat.com/documentation/en-us/red_hat_3scale_api_management/2.9/html/administering_the_api_gateway/apicast_policies#custom-metrics)。

**注意**:3 规模分析仅代表累积指标。因此，对平均值的复杂度量跟踪等。，应该用其他工具来完成。

## 设置自定义指标策略

本节解释了本文所示场景的先决条件，然后是设置。接下来的部分解释了端到端的流程。

### 先决条件

要完成本教程，您需要以下内容:

*   3 大规模 API 管理 2.9 内部部署。
*   返回 HTTP 状态代码的私有后端 API。出于本文的目的，使用 [3scale-private-api](https://github.com/chamalabey/3scale-private-api) 。
*   安全隧道服务的二进制下载。

### 设置

安装并部署 [3scale-private-api 后端](https://github.com/chamalabey/3scale-private-api/blob/master/README.md)。这个简单的应用程序将返回一个带有您通过在请求 URL 中传递状态代码而指定的状态代码的响应。例如，如果在 URL 中包含参数`/status/203`，后端将返回状态 203。

示例应用程序监听端口 3000 上的请求。通过执行以下命令，经由 ngrok 应用程序将端口暴露给互联网:

**注意**:ngrok 生成的公共 URL 在免费层只有八小时有效。

```
$ ./ngrok http 3000
```

当您执行前面的命令时，您将得到类似如下的输出:

```
Forwarding                    http://8fcf5e08d900.ngrok.io -> localhost:30
Forwarding                    https://8fcf5e08d900.ngrok.io -> localhost:3000
```

从输出中复制安全的 HTTPS URL，并将其指定为您的后端，将其粘贴到 **Private Base URL** 字段中，如图 1 所示。

[![The Private Base URL of the backend should be the HTTPS URL generated by ngrok.](../Images/bf260374bd9cae423ee3e475214a2389.png "image2")](/sites/default/files/blog/2021/01/image2.png)

Figure 1: Choosing the private base URL for the backend.

如果没有为您的 API 产品配置后端，请按照[3 规模文档](https://access.redhat.com/documentation/en-us/red_hat_3scale_api_management/2.9/html/getting_started/first-steps#adding-backends-product)中所示为产品配置后端。

根据响应代码配置要更新的产品的新指标。您可以使用`status-*HTTP-STATUS-CODE*`的**系统名称**字段为您想要捕获的所有 HTTP 状态代码创建任意数量的指标，如图 2 所示。

[![To set the status code you would like to have returned, in the &quot;New metric&quot; screen, set the System name to status-HTTP-STATUS-CODE.](../Images/23a15e87b9aec8cf7dca7a31917c0008.png "image6")](/sites/default/files/blog/2021/01/image6.png)

Figure 2: Setting the status that you would like the backend to return.

将[定制度量策略](https://access.redhat.com/documentation/en-us/red_hat_3scale_api_management/2.9/html/administering_the_api_gateway/apicast_policies#custom-metrics)添加到您的服务配置中，如图 3 所示。

[![Under &quot;Select a policy,&quot; choose &quot;Custom Metrics.&quot;](../Images/6757c18b391c68d374aa7a23a34aa2e8.png "image7")](/sites/default/files/blog/2021/01/image7.png)

Figure 3: Selecting the custom metrics policy.

如图 4 所示配置策略。

[![The &quot;Edit policy&quot; screen offers several fields to configure the policy.](../Images/21fa73f42d7459a7f350b11a41ab6965.png "image3")](/sites/default/files/blog/2021/01/image3.png)

Figure 4: Configuring the policy.

更新策略链，并将服务配置提升到 API 产品的试运行和生产环境。

## 端到端流

确保[私有 API 后端](https://github.com/chamalabey/3scale-private-api/blob/master/README.md)应用程序正在运行并通过 ngrok 公开，并且服务后端的私有基本 URL 已正确配置，以反映 ngrok 生成的 URL。

使用正确的凭证向 APIcast 发出请求，以调用配置的服务。注意，下面的请求 URL 与指标`status-203`匹配。如果您有自签名证书，您必须包括`-k`选项:

```
$ curl "https://api-3scale-apicast-staging.apps-crc.testing:443/status/203?user_key=*xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx*" -k
```

您应该会收到类似以下内容的响应:

```
status code 203 set to the header
```

按如下方式发出另一个请求，以更新`status-303`指标:

```
$ curl "https://api-3scale-apicast-staging.apps-crc.testing:443/status/303?user_key=*xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx*" -k<
```

前往**产品分析— >流量**查看有关退货状态代码的指标是否相应更新。

如果您添加了更多指标，它们也会根据您传入的状态代码进行更新。

## 附加注释

要找出 APIcast 的每个步骤中所有可用的液体变量，可以使用 [Liquid Context Debug](https://access.redhat.com/documentation/en-us/red_hat_3scale_api_management/2.8/html/administering_the_api_gateway/apicast_policies#liquid_context_debug) 策略。如果您想使用可用的变量来编写复杂的逻辑表达式，这是很有用的。(我们不会在本文中讨论这个话题。)

**注意**:当您的产品配置中有多个后端时，[液态上下文调试](https://access.redhat.com/documentation/en-us/red_hat_3scale_api_management/2.8/html/administering_the_api_gateway/apicast_policies#liquid_context_debug)策略不起作用。

下面是如何使用液体表达式检查主机头:

1.  将[液态上下文调试](https://access.redhat.com/documentation/en-us/red_hat_3scale_api_management/2.8/html/administering_the_api_gateway/apicast_policies#liquid_context_debug)策略添加到策略链中。该策略需要放在策略链中的 APIcast 策略或上游策略之前。
2.  像往常一样向 APIcast 发出请求。
3.  响应将是 JSON 格式的，每个上下文中都有额外的变量。下面是一个示例请求的片段:

    ```
    "http_method": "GET",
    "already_seen": "ALREADY SEEN - NOT CALCULATING AGAIN TO AVOID CIRCULAR REFS",
    "remote_port": "52672",
    "remote_addr": "10.116.0.1",
    "current": {
    "host": "api-3scale-apicast-staging.apps-crc.testing",
    "original_request": {
    "current": {
    "host": "api-3scale-apicast-staging.apps-crc.testing",
    "query": "user_key=267c255c50b842ca0ebf9cf4ee2bfd1e",
    "path": "\/",
    "headers": {
    "host": "api-3scale-apicast-staging.apps-crc.testing",
    "x-forwarded-host": "api-3scale-apicast-staging.apps-crc.testing",
    "x-forwarded-for": "192.168.130.1",
    "user-agent": "curl\/7.66.0",
    "forwarded": "for=192.168.130.1;host=api-3scale-apicast-staging.apps-crc.testing;proto=https",
    "x-forwarded-port": "443",
    "x-forwarded-proto": "https",
    "accept": "*\/*"
    },
    "uri": "\/",
    "server_addr": "10.116.0.83"
    },
    "next": {
    "already_seen": "ALREADY SEEN - NOT CALCULATING AGAIN TO AVOID CIRCULAR REFS"
    }
    },

    ```

4.  注意`original_request`变量下可用的`host`、`query`和`headers`等变量。您可以在支持液体值的策略中使用液体标签来访问这些值。例如，您可以通过使用液体标签`{{original_request['host']}}`来访问原始主机名。

## 结论

在本文中，您了解了如何使用自定义指标策略来捕获特定状态代码的分析，默认情况下，3scale API Management 不会单独捕获这些代码。您还了解了如何使用 Liquid Context 调试策略来找出可在 APIcast 策略中使用的变量。

我希望本指南为您提供了足够的工具来实现类似于所描述的解决方案。欢迎提出任何改进此内容的建议。

## 下一步是什么？

使用本指南作为参考来跟踪 3scale analytics 中的替代指标，如有疑问，请立即联系[支持团队](https://access.redhat.com/support)或在 APIcast GitHub 存储库中提出问题。

*Last updated: August 15, 2022*